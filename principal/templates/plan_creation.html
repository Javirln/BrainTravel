{% extends 'base.html' %}
{% load staticfiles %}
{% load i18n %}
{% block title %} {% trans "Plan a trip" %} {% endblock %}
{% block content %}

<div class="container">

    <div class="col-xs-12 col-sm-6 col-sm-offset-3">
    <h1 class="page-header">{% trans "Plan a trip" %}</h1>
        <form id="form-create" class="form-horizontal" role="form" action="/planner/list_venues/" method="post"
              data-toggle="validator">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_city" class="control-label">{% trans "City" %}</label>
                    <input class="form-control" id="id_city" name="city" type="text"
                           value="{% if form.initial|length != 0 %}{{ form.initial.city }}{% else %}{{ form.data.city }}{% endif %}"
                           required/>
                    <div class="help-block with-errors"></div>
                </div>

                <div class="form-group">
                    <label for="id_country"
                           class="control-label">{% trans "Country" %}</label>
                    <input class="form-control" id="id_country" name="country" type="text"
                           value="{% if form.initial|length != 0 %}{{ form.initial.country }}{% else %}{{ form.data.country }}{% endif %}"
                           required/>
                    <div class="help-block with-errors"></div>
                </div>

                <div class="form-group">
                    <label for="id_days"
                           class="control-label">{% trans "Days" %}</label>
                    <input class="form-control" id="id_days" name="days" type="number" min="1" max="7"
                           value="{% if form.initial|length != 0 %}{{ form.initial.days }}{% else %}{{ form.data.days }}{% endif %}"
                           required onchange="calculatePlanPrice(this.value);"/>
                    <div class="help-block with-errors"></div>
                </div>

                <div class="form-group text-center">
                    <h4>{% trans "Price" %} <span id="tripPrice">-</span> {% trans "Coins" %}</h4>
                    <h4>{% trans "You have" %}: <span id="myCoins">{{traveller.coins}}</span> {% trans "coins" %}</h4>
                </div>

                <div class="form-group">
                    <input id="create_plan" class="btn btn-primary btn-block" name="save"
                           value="{% trans "Create Plan" %}"
                           type="submit" onclick=whileLoading()>
                </div>


            <div class="form-group">
                <label for="selec">{% trans "Select your custom constrains" %}</label>
                <select id="selec" style="display: none;"  class="chosen-select">
                    <option></option>
                    {% for cat in list_cat %}
                        <option value= {{ cat.id_foursquare }}>{% trans cat.name %}</option>
                    {% endfor %}

                </select>

                <label for="cantidad">Selec cantidad</label>
                <select id="cantidad" style="display: none;" class="chosen-select"
                        tabindex="-1">
                    <option value=""></option>
                    <option value="Mucho">{% trans "A lot of" %}</option>
                    <option value="Poco">{% trans "Some of" %}</option>
                    <option value="Nada">{% trans "Anything of" %}</option>
                </select>
            <div>
                <br>

                <input class="btn btn-primary" id="copy" name="copy"
                       value="{% trans 'Add Restriction' %}" type="button" onclick=copyValues()>
                    <input class="form-control" type="hidden" readonly name="rests" id="rest1"/>
                    <input class="form-control" type="hidden" readonly name="rests" id="rest2"/>
                    <input class="form-control" type="hidden" readonly name="rests" id="rest3"/>
            </div>
                </div>
    </form>

<div class="form-group">
    <fieldset><legend>{% trans "Custom constraints" %}</legend>
        <input class="form-control" type="text" readonly name="rests" id="rest1_lb1"/>
        <input type="hidden" class="btn btn-primary" id="delete1" name="Delete lb1"
               value="{% trans "Delete" %}" onclick=deleteHidden("1")>
        <br>
        <input class="form-control" type="text" readonly name="rests" id="rest1_lb2"/>
        <input type="hidden" class="btn btn-primary" id="delete2" name="Delete lb2"
               value="{% trans "Delete " %}" onclick=deleteHidden("2")>
        <br>
        <input class="form-control" type="text" readonly name="rests" id="rest1_lb3"/>
        <input type="hidden" readonly class="btn btn-primary" id="delete3" name="Delete lb3"
               value="{% trans "Delete" %}" onclick=deleteHidden("3")>
        <br>
        </fieldset>
</div>

    </div>
</div>
<script>

function deleteHidden(number){
    var target = "rest" + number;
    var rest_lbN = "rest1_lb" + number;
    var deleteTo = "delete" + number;
    //borramos el hidden
    $('#' + target).val("");
    //Borramos el visible
    $('#' + rest_lbN).val("");
    //Habilitamos el boton de agregar mas restricciones
    $("#copy").prop('disabled', false);
    //desabilitamos el boton de borrar
    $('#' + deleteTo).prop("type", "hidden");
}

function copyValues() {
    var category;
    var cantidad;

    cantidad = $("#cantidad").find('option:selected').text();
    category = $("#selec").find('option:selected').text();

    //son los hidden
    var input1 = $("#rest1");
    var input2 = $("#rest2");
    var input3 = $("#rest3");

    //son los que se ven en la pantalla
    var rest_lb1 = $("#rest1_lb1");
    var rest_lb2 = $("#rest1_lb2");
    var rest_lb3 = $("#rest1_lb3");

    //selecciona la id_categoria
    var cat_id = jQuery("#selec option:selected").val();

    //selecciona la cantidad
    var vals = jQuery("#cantidad option:selected").val();

    var txt1 = input1.val();
    var txt2 = input2.val();
    var txt3 = input3.val();

    if (category == input1.val().split(":")[0] || category == input2.val().split(":")[0] || category == input3.val().split(":")[0]) {
        return false;
    }

    if (txt1 == "") {
        input1.val(cat_id + ":" + vals);
        rest_lb1.val(category + ": " + cantidad);
        $("#delete1").prop("type", "button");
    }
    else if (txt2 == "") {
        input2.val(cat_id + ":" + vals);
        rest_lb2.val(category + ": " + cantidad);
        $("#delete2").prop("type", "button");
    }
    else if (txt3 == "") {
        input3.val(cat_id + ":" + vals);
        rest_lb3.val(category + ": " + cantidad);
        $("#delete3").prop("type", "button");
    }

    if (input1.val() != "" && input2.val() != "" && input3.val() != "") {
        $("#copy").prop('disabled', true);
    }
}
    function calculatePlanPrice(days){
        var coins;
        coins = 0;

        if (days <= 3) {
            coins = 20
        } else if (days > 3 && days <= 7) {
            coins = 40
        } else {
            coins = 80
        }
        var availableCoins= $('#myCoins').text();
        if (coins > availableCoins){
            $("#create_plan").prop('disabled', true);
        }else{
            $("#create_plan").prop('disabled', false);
        }
        $('#tripPrice').empty().append(coins);
    }

     $(function() {
        $('.chosen-select').chosen();
        $('.chosen-select-deselect').chosen({ allow_single_deselect: true });
      });


    function whileLoading() {
        swal({
            title: "Loading...",
            text: " {%  trans "We are working hard on your plan. It might take a while, please, be patient :)"%}",
            showConfirmButton: false,
            imageUrl: "{% static "img/gears.svg" %}"
        });
    }

    $(document).ready(function () {
        $('#id_startDate').datepicker({
            format: 'dd/mm/yyyy',
            autoclose: true
        });

        $('#form-create').change(function(){
            if ($('#id_country').val() == '' || $('#id_city').val() == '' || $('#id_days').val() == '' || $('#id_startDate').val() == '') {
                $('#create_plan').prop('disabled', true);
            }else{
                $('#create_plan').prop('disabled', false);
            }
        });
    });
</script>

{% endblock %}